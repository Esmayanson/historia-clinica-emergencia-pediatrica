<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Informe de Historia Cl√≠nica de Emergencia</title>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        .informe-editor[contenteditable="true"] {
            min-height: 150px; 
            border: 1px solid #ccc;
            padding: 10px;
            overflow-y: auto;
            white-space: pre-wrap; 
        }
        #evolucion-ordenes-editor {
             min-height: 350px; 
        }
        /* Estilos para los nuevos controles de paciente */
        .patient-controls {
            display: flex;
            align-items: center;
            padding: 10px 0;
            gap: 10px;
            font-weight: bold;
            font-size: 0.9em;
            margin-bottom: 5px;
            flex-wrap: wrap; 
        }
        .patient-controls input[type="number"], .patient-controls select {
            padding: 5px;
            border: 1px solid #ccc;
        }
        .patient-controls input[type="number"] {
            width: 40px;
        }
        .btn-gender {
            background-color: #f0f0f0;
            border: 1px solid #ccc;
            padding: 5px 10px;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        .btn-gender.active {
            background-color: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }
    </style>
    
    <script src="data.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>

    <div class="container">
        <div class="left-column">
            <h2>Motivos de Emergencia</h2>
            <ul id="motivos-lista">
                </ul>
        </div>

        <div class="right-column">
            
            <div class="patient-controls">
                <label>G√©nero:</label>
                <button id="btn-masculino" onclick="setGenero('M')" class="btn-gender active">Masculino</button>
                <button id="btn-femenino" onclick="setGenero('F')" class="btn-gender">Femenino</button>

                <label style="margin-left: 20px;">Edad:</label>
                <input type="number" id="edad-input" min="0" value="1" oninput="aplicarVariables()">
                <select id="unidad-select" onchange="aplicarVariables()">
                    <option value="a√±os">a√±os</option>
                    <option value="meses">meses</option>
                </select>

                <label style="margin-left: 20px;">Pariente:</label>
                <select id="pariente-select" onchange="aplicarVariables()">
                    <option value="madre">Madre</option>
                    <option value="padre">Padre</option>
                    <option value="tutor">Tutor</option>
                </select>

                <label style="margin-left: 20px;">Peso:</label>
                <input type="number" id="peso-input" min="0" value="10" oninput="aplicarVariables()">
                <select id="unidad-peso-select" onchange="aplicarVariables()">
                    <option value="libras">libras</option>
                    <option value="kg">kg</option>
                </select>
            </div>
            
            <div class="toolbar">
                <button title="Negrita" onclick="formatDoc('bold')"><i class="fas fa-bold"></i></button>
                <button title="Cursiva" onclick="formatDoc('italic')"><i class="fas fa-italic"></i></button>
                <button title="Subrayado" onclick="formatDoc('underline')"><i class="fas fa-underline"></i></button>
                <button title="Resaltado" onclick="formatDoc('backcolor', prompt('Color de Resaltado (ej: yellow):', 'yellow'))"><i class="fas fa-highlighter"></i></button>
            </div>
            
            <div class="informe-sheet" id="informe-sheet">
                <h1 id="motivo-titulo">Seleccione un Motivo</h1>
                
                <section class="informe-section">
                    <h3>Presentaci√≥n de Caso</h3>
                    <div id="presentacion-caso-editor" class="informe-editor" contenteditable="true"></div>
                </section>
                
                <section class="informe-section">
                    <h3>Evoluci√≥n y √ìrdenes M√©dicas</h3>
                    <div id="evolucion-ordenes-editor" class="informe-editor" contenteditable="true"></div>
                </section>
                
                <div class="document-footer">
                    <p>Creado por: Dr. Esmayanson de Le√≥n</p>
                </div>
            </div>

            <div class="action-buttons">
                <button onclick="restablecer()" class="btn-restablecer">Restablecer</button>
                <button onclick="imprimir()" class="btn-imprimir"><i class="fas fa-print"></i> Imprimir</button>
                <button onclick="guardarTxt()" class="btn-guardar-txt">Guardar TXT</button>
                <button onclick="guardarPdf()" class="btn-guardar-pdf"><i class="fas fa-file-pdf"></i> Guardar PDF</button>
            </div>

        </div>
    </div>

    <script>
        
        let generoActual = 'M';
        let informeActualRaw = { presentacion: '', evolucion_ordenes: '' }; 

        function formatDoc(command, value = null) {
            document.execCommand(command, false, value);
        }

        function setGenero(genero) {
            generoActual = genero;
            document.querySelectorAll('.btn-gender').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`btn-${genero === 'M' ? 'masculino' : 'femenino'}`).classList.add('active');
            aplicarVariables(); 
        }
        
        function aplicarSustitucionGenero(texto, genero) {
            if (genero === 'F') {
                // MASCULINO --> FEMENINO
                texto = texto
                    .replace(/hipoactivo/gi, 'hipoactiva')
                    .replace(/eupneico/gi, 'eupneica')
                    .replace(/despierto/gi, 'despierta')
                    .replace(/orientado/gi, 'orientada')
                    .replace(/quejumbroso/gi, 'quejumbrosa')
                    .replace(/agitado/gi, 'agitada');
            } else {
                // FEMENINO --> MASCULINO
                texto = texto
                    .replace(/hipoactiva/gi, 'hipoactivo')
                    .replace(/eupneica/gi, 'eupneico')
                    .replace(/despierta/gi, 'despierto')
                    .replace(/orientada/gi, 'orientado')
                    .replace(/quejumbrosa/gi, 'quejumbroso')
                    .replace(/agitada/gi, 'agitado');
            }
            return texto;
        }

        // üü¢ MODIFICADA: Construye la frase introductoria y la frase de cierre con el peso
        function construirFraseIntroduccion() {
            const edad = document.getElementById('edad-input').value;
            const unidadEdad = document.getElementById('unidad-select').value;
            const generoText = generoActual === 'M' ? 'masculino' : 'femenina';
            const pariente = document.getElementById('pariente-select').value;
            
            // Frase gen√©rica de apertura
            let intro = `Paciente ${generoText} de ${edad} ${unidadEdad} de edad. Es tra√≠do por su ${pariente}. `;
            
            return intro;
        }
        
        // üü¢ NUEVA FUNCI√ìN DE UTILIDAD: Crea la frase de cierre din√°mica (g√©nero y peso)
        function construirFraseCierre() {
            const generoCierre = generoActual === 'M' ? 'tra√≠do' : 'tra√≠da';
            const peso = document.getElementById('peso-input').value;
            const unidadPeso = document.getElementById('unidad-peso-select').value;
            
            // Ejemplo: "por tal motivo es tra√≠do a este centro de salud. Paciente pesa 19 libras."
            let cierre = ` Por tal motivo es ${generoCierre} a este centro de salud. Paciente pesa ${peso} ${unidadPeso}.`;
            
            return cierre;
        }

        function aplicarVariables() {
            const edad = document.getElementById('edad-input').value;
            const unidadEdad = document.getElementById('unidad-select').value;
            const generoText = generoActual === 'M' ? 'masculino' : 'femenina';
            const pariente = document.getElementById('pariente-select').value;
            
            if (!informeActualRaw.presentacion) return; 

            // --- 1. PRESENTACI√ìN DE CASO (A√±adir/sustituir G√©nero/Edad/Pariente/Cierre) ---
            let presentacionModificada = informeActualRaw.presentacion;
            const introDinamica = construirFraseIntroduccion();
            const fraseCierreDinamica = construirFraseCierre();
            
            // 1a. Sustituci√≥n o Inserci√≥n de la INTRO (G√©nero, Edad, Pariente)
            const hasAgeAndGenderPattern = /(masculino|femenina)\s+de\s+\d+\s+(a√±os|meses)\s+de\s+edad/i;
            const parientePattern = /los padres|sus padres|la madre|el padre|el tutor|su tutor/gi;
            
            if (hasAgeAndGenderPattern.test(presentacionModificada)) {
                // Sustituci√≥n si el patr√≥n de edad/g√©nero ya existe
                presentacionModificada = presentacionModificada.replace(hasAgeAndGenderPattern, 
                                                                       `${generoText} de ${edad} ${unidadEdad} de edad`);
                presentacionModificada = presentacionModificada.replace(parientePattern, `su ${pariente}`);
            } else {
                // Inserci√≥n si el patr√≥n falta
                presentacionModificada = introDinamica + presentacionModificada;
            }

            // 1b. Limpiar la Presentaci√≥n de cualquier frase de cierre antigua antes de a√±adir la nueva
            presentacionModificada = presentacionModificada.replace(/ Por tal motivo es (tra√≠do|tra√≠da) a este centro de salud\. Paciente pesa \d+ (libras|kg)\./gi, '');


            // 1c. Aplicar sustituci√≥n de adjetivos a la Presentaci√≥n
            presentacionModificada = aplicarSustitucionGenero(presentacionModificada, generoActual);
            
            // 1d. A√±adir la NUEVA frase de cierre din√°mica al final
            presentacionModificada += fraseCierreDinamica; 
            
            document.getElementById('presentacion-caso-editor').innerHTML = presentacionModificada.replace(/\n/g, '<br>');

            // --- 2. EVOLUCI√ìN Y √ìRDENES (Solo Sustituci√≥n de Adjetivos) ---
            let evolucionModificada = informeActualRaw.evolucion_ordenes;
            evolucionModificada = aplicarSustitucionGenero(evolucionModificada, generoActual);
            
            document.getElementById('evolucion-ordenes-editor').innerHTML = evolucionModificada.replace(/\n/g, '<br>');
        }

        function cargarInforme(motivo, esInicial = false) {
            document.querySelectorAll('.motivo-item').forEach(item => item.classList.remove('active'));
            const listItem = Array.from(document.querySelectorAll('.motivo-item')).find(item => item.textContent === motivo);
            if (listItem) listItem.classList.add('active');

            const datos = dataInformes[motivo] || dataInformes["DIAGNOSTICO NO INCLUIDO EN DATA"];
            
            document.getElementById('motivo-titulo').textContent = motivo;
            
            // Guardar el texto original (RAW) antes de cualquier modificaci√≥n
            informeActualRaw.presentacion = datos.presentacion;
            informeActualRaw.evolucion_ordenes = datos.evolucion_ordenes;

            aplicarVariables();
        }

        function inicializarInterfaz() {
            // Obtiene los motivos de dataInformes para la lista lateral
            const motivosLista = Object.keys(dataInformes); 
            
            const listaUl = document.getElementById('motivos-lista');
            listaUl.innerHTML = ''; 
            
            motivosLista.forEach(motivo => {
                const li = document.createElement('li');
                li.textContent = motivo;
                li.classList.add('motivo-item');
                li.onclick = () => cargarInforme(motivo); 
                listaUl.appendChild(li);
            });

            if (motivosLista.length > 0) {
                cargarInforme(motivosLista[0], true);
            }
        }
        
        // =======================================================
        // FUNCIONES DE ACCI√ìN
        // =======================================================

        function restablecer() { 
            const motivoActual = document.getElementById('motivo-titulo').textContent;
            cargarInforme(motivoActual, false); 
            alert(`‚úÖ Campos de Presentaci√≥n, Evoluci√≥n y √ìrdenes restablecidos para: ${motivoActual}`);
        }

        function imprimir() { 
            window.print();
        }

        function guardarTxt() { 
            const titulo = document.getElementById('motivo-titulo').textContent;
            const presentacion = document.getElementById('presentacion-caso-editor').textContent; 
            const evolucionOrdenes = document.getElementById('evolucion-ordenes-editor').textContent;
            const creador = document.querySelector('.document-footer p').textContent;

            const contenido = 
                `--- INFORME CL√çNICO DE EMERGENCIA ---\n` +
                `Motivo de Emergencia: ${titulo}\n` +
                `-----------------------------------------\n\n` +
                `[PRESENTACI√ìN DE CASO]\n` +
                `${presentacion}\n\n` +
                `[EVOLUCI√ìN Y √ìRDENES M√âDICAS]\n` +
                `${evolucionOrdenes}\n\n` +
                `-----------------------------------------\n` +
                `${creador}\n`;

            const nombreArchivo = `${titulo.replace(/[^a-z0-9]/gi, '_')}_Informe.txt`;

            const blob = new Blob([contenido], { type: 'text/plain;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = nombreArchivo; 
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert(`üíæ Archivo '${nombreArchivo}' generado y descargado.`);
        }

        async function guardarPdf() { 
            const input = document.getElementById('informe-sheet');
            const titulo = document.getElementById('motivo-titulo').textContent;
            const nombreArchivo = `${titulo.replace(/[^a-z0-9]/gi, '_')}_Informe.pdf`;
            
            const toolbar = document.querySelector('.toolbar');
            const patientControls = document.querySelector('.patient-controls'); 
            
            // Ocultar barras para que no aparezcan en el PDF
            toolbar.style.display = 'none';
            patientControls.style.display = 'none';

            try {
                const canvas = await html2canvas(input, { scale: 2 });
                
                const imgData = canvas.toDataURL('image/png');
                const pdf = new window.jspdf.jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });

                const imgWidth = 210;
                const pageHeight = 297;
                const imgHeight = canvas.height * imgWidth / canvas.width;
                let heightLeft = imgHeight;
                let position = 0;

                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;

                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }
                
                pdf.save(nombreArchivo);
                alert(`üéâ Archivo PDF '${nombreArchivo}' generado y descargado.`);
            } catch (error) {
                console.error("Error al generar PDF:", error);
                alert("Hubo un error al generar el PDF. Revisa la consola para m√°s detalles.");
            } finally {
                // Volver a mostrar las barras despu√©s de la captura
                toolbar.style.display = 'flex';
                patientControls.style.display = 'flex'; 
            }
        }

        window.onload = inicializarInterfaz;
    </script>
</body>
</html>